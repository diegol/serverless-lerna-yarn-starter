# NOTE: update this with your service name
service: serverless-typescript-starter

# Create an optimized package for our functions
package:
  individually: true

plugins:
  - serverless-offline
  - serverless-dotenv-plugin
  - serverless-bundle

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage,'local'}
  logRetentionInDays: 14
  region: us-east-1
  iamRoleStatements:
    - Effect: Allow
      Action:
        - lambda:InvokeFunction
      Resource:
        - "*"
    - Effect: Allow
      Action:
        - s3:*
      Resource:
        - "*"
  # To load environment variables externally
  # rename env.example to .env and uncomment
  # the following line. Also, make sure to not
  # commit your .env.
  #
  environment:
    OPEN_AI_BUCKET: ${self:custom.environment.openAiBucket}
    ACCESS_KEY_ID: ${self:custom.environment.accessKeyId}
    SECRET_ACCESS_KEY: ${self:custom.environment.secretAccessKey}
    ENV: ${self:provider.stage}
functions:
  hello:
    handler: handler.hello
    events:
      - http:
          path: hello
          method: get
  summary:
    handler: handler.summary
  # search:
  #   handler: search.main
  #   events:
  #     - http:
  #         path: openapi/search
  #         method: get

  # complete:
  #   handler: complete.main
  #   events:
  #     - http:
  #         path: openapi/complte
  #         method: get
custom:
  environment: ${file(./config/environment.${self:provider.stage}.yml)}
  bundle:
    externals:
      - class-transformer
      - "@nestjs/microservices"
      - "cache-manager"
      - "@nestjs/microservices/microservices-module"
      - "@nestjs/websockets/socket-module"
    packager: yarn
    linting: false
    stats: true
  localstack:
    stages:
      # list of stages for which the plugin should be enabled
      - local
    host: http://localhost # optional - LocalStack host to connect to
    edgePort: 4566 # optional - LocalStack edge port to connect to
    autostart: true # optional - start LocalStack in Docker on Serverless deploy
    lambda:
      # Enable this flag to improve performance
      mountCode: True
    docker:
      # Enable this flag to run "docker ..." commands as sudo
      sudo: False
